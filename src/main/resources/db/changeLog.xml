<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="exhibitions" author="antti.leppa">
        <createTable tableName="exhibition">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="visitorsessions" author="antti.leppa">
        <createTable tableName="visitorsession">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITORSESSION_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
        </createTable>

        <createTable tableName="visitorsessionvariable">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VARIABLE_VISITORSESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
        </createTable>

        <createTable tableName="visitorsessionuser">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="userId" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="tagId" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_USER_VISITORSESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="rooms" author="antti.leppa">
        <createTable tableName="exhibitionroom">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITIONROOM_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devicegroups" author="antti.leppa">
        <createTable tableName="exhibitiondevicegroup">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_GROUP_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devices" author="antti.leppa">
        <createTable tableName="exhibitiondevice">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="exhibitionDeviceGroup_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
            <column name="locationX" type="double"/>
            <column name="locationY" type="double"/>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devicemodels" author="antti.leppa">
        <createTable tableName="exhibitiondevicemodel">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="manufacturer" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="model" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="dimensionWidth" type="double"/>
            <column name="dimensionHeight" type="double"/>
            <column name="resolutionX" type="double"/>
            <column name="resolutionY" type="double"/>
            <column name="capabilityTouch" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_MODEL_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitiondevice">
            <column name="exhibitionDeviceModel_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_MODEL_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicemodel"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="layouts" author="antti.leppa">
        <createTable tableName="exhibitionpagelayout">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_LAYOUT_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="pages" author="antti.leppa">
        <createTable tableName="exhibitionpage">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="resources" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="events" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="eventTriggers" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="layout_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_LAYOUT_ID" referencedColumnNames="id" referencedTableName="exhibitionpagelayout"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="pagesdropevents" author="antti.leppa">
        <dropColumn tableName="exhibitionpage">
            <column name="events"/>
        </dropColumn>
    </changeSet>

    <changeSet id="nonexhibitionpagelayouts" author="antti.leppa">
        <dropForeignKeyConstraint baseTableName="exhibitionpage" constraintName="FK_EXHIBITION_PAGE_LAYOUT_ID"/>
        <dropForeignKeyConstraint baseTableName="exhibitionpagelayout" constraintName="FK_EXHIBITION_PAGE_LAYOUT_EXHIBITION_ID"/>
        <dropColumn tableName="exhibitionpagelayout" columnName="exhibition_id"/>
        <renameTable oldTableName="exhibitionpagelayout" newTableName="pagelayout" />
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="layout_id" constraintName="FK_EXHIBITION_PAGE_PAGE_LAYOUT_ID" referencedTableName="pagelayout" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="layoutthumbnailurl" author="antti.leppa">
        <addColumn tableName="pagelayout">
            <column name="thumbnailUrl" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="devicedisplaymetrics" author="antti.leppa">
        <addColumn tableName="exhibitiondevicemodel">
            <column name="heightPixels" type="INTEGER"/>
            <column name="widthPixels" type="INTEGER"/>
            <column name="density" type="DOUBLE"/>
            <column name="xdpi" type="DOUBLE"/>
            <column name="ydpi" type="DOUBLE"/>
        </addColumn>

        <sql>UPDATE exhibitiondevicemodel set heightPixels = resolutionY</sql>
        <sql>UPDATE exhibitiondevicemodel set widthPixels = resolutionX</sql>

        <dropColumn tableName="exhibitiondevicemodel">
            <column name="resolutionY"/>
        </dropColumn>

        <dropColumn tableName="exhibitiondevicemodel">
            <column name="resolutionX"/>
        </dropColumn>
    </changeSet>

    <changeSet id="screenorientations" author="jari.nykanen">
        <addColumn tableName="exhibitiondevice">
            <column name="screenOrientation" type="varchar(20)" defaultValue="portrait">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="pagelayout">
            <column name="screenOrientation" type="varchar(20)" defaultValue="portrait">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="screenorientationdefaults" author="antti.leppa">
        <sql>UPDATE exhibitiondevice SET screenOrientation = 'PORTRAIT'</sql>
        <sql>UPDATE pagelayout SET screenOrientation = 'PORTRAIT'</sql>
        <dropDefaultValue tableName="exhibitiondevice" columnName="screenOrientation" />
        <dropDefaultValue tableName="pagelayout" columnName="screenOrientation" />
    </changeSet>

    <changeSet id="devicemodelsoutofexhibition" author="antti.leppa">
        <dropForeignKeyConstraint baseTableName="exhibitiondevice" constraintName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_MODEL_ID"/>
        <renameColumn tableName="exhibitiondevice" columnDataType="binary(16)" newColumnName="deviceModel_id" oldColumnName="exhibitionDeviceModel_id" />
        <dropForeignKeyConstraint baseTableName="exhibitiondevicemodel" constraintName="FK_EXHIBITION_DEVICE_MODEL_EXHIBITION_ID"/>
        <dropColumn tableName="exhibitiondevicemodel" columnName="exhibition_id"/>
        <renameTable oldTableName="exhibitiondevicemodel" newTableName="devicemodel" />
        <addForeignKeyConstraint baseTableName="exhibitiondevice" baseColumnNames="deviceModel_id" constraintName="FK_EXHIBITION_DEVICE_DEVICE_MODEL_ID" referencedTableName="devicemodel" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="deviceidtoexhibitionpage" author="jari.nykanen">
        <addColumn tableName="exhibitionpage">
            <column name="device_id" type="binary(16)"/>
        </addColumn>

        <sql>UPDATE exhibitionpage SET device_id = (SELECT ID FROM exhibitiondevice LIMIT 1)</sql>

        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionpage" columnName="device_id"/>
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="device_id" constraintName="FK_EXHIBITION_PAGE_DEVICE_ID" referencedTableName="exhibitiondevice" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="devicedimensionsupdate" author="jari.nykanen">
        <renameColumn tableName="devicemodel" oldColumnName="dimensionWidth" newColumnName="deviceWidth" columnDataType="INTEGER"/>
        <renameColumn tableName="devicemodel" oldColumnName="dimensionHeight" newColumnName="deviceHeight" columnDataType="INTEGER"/>

        <addColumn tableName="devicemodel">
            <column name="deviceDepth" type="INTEGER"/>
            <column name="screenWidth" type="INTEGER"/>
            <column name="screenHeight" type="INTEGER"/>
        </addColumn>
    </changeSet>

    <changeSet id="contentversions" author="antti.leppa">
        <createTable tableName="exhibitioncontentversion">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_CONTENT_VERSION_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitionpage">
            <column name="contentVersion_id" type="binary(16)"/>
        </addColumn>
    </changeSet>

    <changeSet id="defaultcontentversions" author="antti.leppa" context="production">
        <sql>INSERT INTO exhibitioncontentversion(id, name, exhibition_id, createdat, modifiedat, creatorid, lastmodifierid) SELECT id, 'default', id, createdat, modifiedat, creatorid, lastmodifierid FROM exhibition</sql>
        <sql>UPDATE exhibitionpage SET contentVersion_id = (SELECT ID FROM exhibitioncontentversion LIMIT 1)</sql>
    </changeSet>

    <changeSet id="pagecontentversionforeignkey" author="antti.leppa">
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionpage" columnName="contentVersion_id"/>
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="contentVersion_id" constraintName="FK_EXHIBITION_PAGE_CONTENT_VERSION_ID" referencedTableName="exhibitioncontentversion" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="modelidtopagelayout" author="jari.nykanen">
        <addColumn tableName="pagelayout">
            <column name="deviceModel_id" type="binary(16)"/>
        </addColumn>

        <sql>UPDATE pagelayout SET deviceModel_id = (SELECT ID FROM devicemodel LIMIT 1)</sql>

        <addNotNullConstraint columnDataType="binary(16)" tableName="pagelayout" columnName="deviceModel_id"/>
        <addForeignKeyConstraint baseTableName="pagelayout" baseColumnNames="deviceModel_id" constraintName="FK_PAGE_LAYOUT_DEVICE_MODEL_ID" referencedTableName="devicemodel" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="floors" author="antti.leppa">
        <createTable tableName="exhibitionfloor">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_FLOOR_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitionroom">
            <column name="floor_id" type="binary(16)"/>
        </addColumn>

        <addColumn tableName="exhibitiondevicegroup">
            <column name="room_id" type="binary(16)"/>
        </addColumn>
    </changeSet>

    <changeSet id="floorsdefaults" author="antti.leppa" context="production">
        <sql>INSERT INTO exhibitionfloor(id, name, exhibition_id, createdat, modifiedat, creatorid, lastmodifierid) SELECT id, 'default', id, createdat, modifiedat, creatorid, lastmodifierid FROM exhibition</sql>
        <sql>UPDATE exhibitionroom SET floor_id = (SELECT ID FROM exhibitionfloor LIMIT 1)</sql>
        <sql>UPDATE exhibitiondevicegroup SET room_id = (SELECT ID FROM exhibitionroom LIMIT 1)</sql>
    </changeSet>

    <changeSet id="floorsforeigns" author="antti.leppa">
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionroom" columnName="floor_id"/>
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitiondevicegroup" columnName="room_id"/>

        <addForeignKeyConstraint baseTableName="exhibitionroom"
             baseColumnNames="floor_id"
             constraintName="FK_EXHIBITION_ROOM_FLOOR_ID"
             referencedTableName="exhibitionfloor"
             referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="exhibitiondevicegroup"
             baseColumnNames="room_id"
             constraintName="FK_EXHIBITION_DEVICE_GROUP_ROOM_ID"
             referencedTableName="exhibitionroom"
             referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="exhibitiondeviceindexpage" author="antti.leppa">
        <addColumn tableName="exhibitiondevice">
            <column name="indexPage_id" type="binary(16)">
                <constraints nullable="true" foreignKeyName="FK_EXHIBITION_DEVICE_INDEX_PAGE_ID" referencedColumnNames="id" referencedTableName="exhibitionpage"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="floorplanurl" author="jari.nykanen">
        <addColumn tableName="exhibitionfloor">
            <column name="floorPlanUrl" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="roompolygon" author="jari.nykanen">
        <addColumn tableName="exhibitionroom">
            <column name="geoShape" type="longtext"/>
        </addColumn>
    </changeSet>

    <changeSet id="geobounds" author="jari.nykanen">
        <addColumn tableName="exhibitionfloor">
            <column name="swBoundPoint" type="Geometry"/>
            <column name="neBoundPoint" type="Geometry"/>
        </addColumn>
    </changeSet>

    <changeSet id="pagetransitions" author="antti.leppa">
        <addColumn tableName="exhibitionpage">
            <column name="enterTransitions" type="longtext"/>
        </addColumn>

        <addColumn tableName="exhibitionpage">
            <column name="exitTransitions" type="longtext"/>
        </addColumn>
    </changeSet>

    <changeSet id="roompolygonformat" author="jari.nykanen">
        <dropColumn tableName="exhibitionroom">
            <column name="geoShape"/>
        </dropColumn>
        <addColumn tableName="exhibitionroom">
            <column name="geoShape" type="Geometry"/>
        </addColumn>
    </changeSet>

    <changeSet id="contentversionchanges" author="jari.nykanen">
        <dropForeignKeyConstraint baseTableName="exhibitioncontentversion" constraintName="FK_EXHIBITION_CONTENT_VERSION_EXHIBITION_ID"/>
        <renameTable oldTableName="exhibitioncontentversion" newTableName="contentversion"/>
        <addColumn tableName="contentversion">
            <column name="language" type="varchar(191)"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="contentversion" baseColumnNames="exhibition_id" constraintName="FK_CONTENT_VERSION_EXHIBITION_ID" referencedTableName="exhibition" referencedColumnNames="id"/>

        <createTable tableName="groupcontentversion">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_GROUP_CONTENT_VERSION_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="status" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="contentversion_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_GROUP_CONTENT_VERSION_CONTENT_VERSION_ID" referencedColumnNames="id" referencedTableName="contentversion"/>
            </column>
            <column name="devicegroup_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_GROUP_CONTENT_VERSION_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="visitor" author="antti.leppa">
        <createTable tableName="visitor">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="tagId" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="userId" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="visitorsessionvisitor">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VISITOR_VISITORSESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
            <column name="visitor_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VISITOR_VISITOR_ID" referencedColumnNames="id" referencedTableName="visitor"/>
            </column>
        </createTable>

        <addUniqueConstraint columnNames="tagId,exhibition_id" constraintName="UN_EXHIBITION_TAG_ID" tableName="visitor"/>

        <dropTable tableName="visitorsessionuser" />

    </changeSet>

    <changeSet id="exhibitiondevicegroupallowvisitorsessioncreation" author="antti.leppa">
        <addColumn tableName="exhibitiondevicegroup">
            <column name="allowVisitorSessionCreation" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="visitorsessionvisiteddevicegroup" author="antti.leppa">
        <createTable tableName="visitorsessionvisiteddevicegroup">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VISITED_DEVICE_GROUP_VISITOR_SESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
            <column name="deviceGroup_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VISITED_DEVICE_GROUP_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
            <column name="enteredAt" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="exitedAt" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint columnNames="visitorSession_id,deviceGroup_id" constraintName="UN_VISITOR_SESSION_VISITED_DEVICE_GROUP_IDS" tableName="visitorsessionvisiteddevicegroup"/>
    </changeSet>

    <changeSet id="roomstocontentversion" author="jari.nykanen">
        <createTable tableName="contentversionroom">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="contentVersion_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_CONTENT_VERSION_ROOM_CONTENTVERSION_ID" referencedColumnNames="id" referencedTableName="contentversion"/>
            </column>
            <column name="exhibitionRoom_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_CONTENT_VERSION_ROOM_ROOM_ID" referencedColumnNames="id" referencedTableName="exhibitionroom"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="rfidantennas" author="antti.leppa">
        <createTable tableName="rfidantenna">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_RFIDANTENNA_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="deviceGroup_id" type="binary(16)">
                <constraints nullable="true" foreignKeyName="FK_RFIDANTENNA_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
            <column name="room_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_RFIDANTENNA_ROOM_ID" referencedColumnNames="id" referencedTableName="exhibitionroom"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="readerId" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="antennaNumber" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="locationX" type="double"/>
            <column name="locationY" type="double"/>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="roomcolor" author="antti.leppa">
        <addColumn tableName="exhibitionroom">
            <column name="color" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="devicemodelorientation" author="jari.nykanen">
        <addColumn tableName="devicemodel">
            <column name="screenOrientation" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>UPDATE devicemodel SET screenOrientation = 'PORTRAIT'</sql>
    </changeSet>

    <changeSet id="sublayouts" author="jari.nykanen">
        <createTable tableName="sublayout">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="pageordernumber" author="antti.leppa">
        <addColumn tableName="exhibitionpage">
            <column name="orderNumber" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="scriptedmode" author="antti.leppa">
        <sql>UPDATE ExhibitionPage SET resources = REPLACE(resources, '"scripted":null', '"mode": "static"')</sql>
        <sql>UPDATE ExhibitionPage SET resources = REPLACE(resources, '"scripted":true', '"mode": "scripted"')</sql>
        <sql>UPDATE ExhibitionPage SET resources = REPLACE(resources, '"scripted":false', '"mode": "static"')</sql>
    </changeSet>

    <changeSet id="exhibitionpage" author="antti.leppa">
        <dropForeignKeyConstraint baseTableName="exhibitiondevice" constraintName="FK_EXHIBITION_DEVICE_INDEX_PAGE_ID"/>

        <dropColumn tableName="exhibitiondevice">
            <column name="indexPage_id"/>
        </dropColumn>
    </changeSet>

    <changeSet id="visitorsessionlanguage" author="antti.leppa">
        <addColumn tableName="visitorsession">
            <column name="language" type="varchar(191)" defaultValue="FI">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="visitorsessionsettings" author="jari.nykanen">
        <addColumn tableName="exhibitiondevicegroup">
            <column name="visitorSessionEndTimeout" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="rfidantenna">
            <column name="visitorSessionStartThreshold" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="visitorSessionEndThreshold" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>UPDATE exhibitiondevicegroup SET visitorSessionEndTimeout = 5000</sql>
        <sql>UPDATE rfidantenna SET visitorSessionStartThreshold = 80</sql>
        <sql>UPDATE rfidantenna SET visitorSessionEndThreshold = 10</sql>
    </changeSet>

    <changeSet id="devicegroupvisitorsessionstartstrategy" author="antti.leppa">
        <addColumn tableName="exhibitiondevicegroup">
            <column name="visitorSessionStartStrategy" type="varchar(20)" defaultValue="othersblock">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
  
    <changeSet id="devicegroupvisitorsessionstartstrategysetdefaults" author="antti.leinonen">
        <sql>UPDATE exhibitiondevicegroup SET visitorSessionStartStrategy = 'OTHERSBLOCK'</sql>
    </changeSet>

    <changeSet id="visitorvariables" author="antti.leppa">
        <createTable tableName="visitorvariable">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="enum" type="longtext"/>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITORVARIABLE_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
        </createTable>

        <addUniqueConstraint columnNames="name,exhibition_id" constraintName="UN_VISITOR_VARIABLE_NAME_EXHIBITION_ID" tableName="visitorvariable"/>

        <sql>
          INSERT INTO
            VisitorVariable (id, createdat, modifiedat, creatorid, lastmodifierid, exhibition_id, name, type)
          SELECT
            UNHEX(REPLACE(UUID(), "-","")), now(), now(), (SELECT creatorid FROM visitorsession LIMIT 1), (SELECT creatorid FROM visitorsession LIMIT 1), (SELECT exhibition_id FROM visitorsession WHERE id = visitorSession_id) AS exhibition_id, name, 'text'
          FROM
            VisitorSessionVariable
          GROUP BY
            exhibition_id, name
        </sql>
    </changeSet>

    <changeSet id="visitorvariablesfix" author="antti.leppa">
        <sql>UPDATE VisitorVariable SET type = 'TEXT'</sql>
    </changeSet>

    <changeSet id="visitorvariableeditable" author="antti.leppa">
        <addColumn tableName="visitorvariable">
            <column name="editableFromUI" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="exhibitiondeviceidlepage" author="antti.leppa">
        <addColumn tableName="exhibitiondevice">
            <column name="idlePage_id" type="binary(16)">
                <constraints nullable="true" foreignKeyName="FK_EXHIBITION_DEVICE_IDLE_PAGE_ID" referencedColumnNames="id" referencedTableName="exhibitionpage"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="exhibitiondevicegroupuniquename" author="antti.leppa">
        <addUniqueConstraint columnNames="room_id,name" constraintName="UN_DEVICE_GROUP_ROOM_NAME" tableName="exhibitiondevicegroup"/>
    </changeSet>

    <changeSet id="contentversionactivecondition" author="antti.leppa">
        <addColumn tableName="contentversion">
            <column name="activeConditionUserVariable" type="varchar(191)"/>
        </addColumn>
        <addColumn tableName="contentversion">
            <column name="activeConditionEquals" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="deviceimageloadstrategy" author="antti.leppa">
        <addColumn tableName="exhibitiondevice">
            <column name="imageLoadStrategy" type="varchar(191)" defaultValue="MEMORY">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="visitorsessionexpires" author="antti.leppa">
        <addColumn tableName="visitorsession">
            <column name="expiresat" type="datetime(6)"/>
        </addColumn>
        <sql>UPDATE visitorsession SET expiresat = ADDTIME(createdAt, "6:00:0.000000")</sql>
        <addNotNullConstraint columnDataType="datetime(6)" tableName="visitorsession" columnName="expiresat"/>
    </changeSet>

    <changeSet id="devicegroupindexpagetimeout" author="antti.leppa">
        <addColumn tableName="exhibitiondevicegroup">
            <column name="indexPageTimeout" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <changeSet id="fix_invalid_enum_value" author="katja danilova">
        <sql>
            UPDATE exhibitiondevice SET screenorientation = 'FORCED_PORTRAIT' WHERE screenorientation = 'FORCEDPORTRAIT';
        </sql>
    </changeSet>

    <changeSet id="default_page_layout_type" author="katja danilova">
        <addColumn tableName="pagelayout">
            <column name="layouttype" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>
            UPDATE pagelayout SET layouttype = 'ANDROID';
        </sql>

        <addColumn tableName="sublayout">
            <column name="layouttype" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>
            UPDATE sublayout SET layouttype = 'ANDROID';
        </sql>
    </changeSet>

    <changeSet id="default_resources_page_sub_layouts" author="katja danilova">
        <addColumn tableName="pagelayout">
            <column name="defaultresources" type="longtext"/>
        </addColumn>

        <addColumn tableName="sublayout">
            <column name="defaultresources" type="longtext"/>
        </addColumn>
    </changeSet>

    <changeSet id="remove_group_contentversion" author="katja danilova">
    <addColumn tableName="contentversion">
            <column name="status" type="varchar(191)"/>
            <column name="devicegroup_id" type="binary(16)">
                <constraints foreignKeyName="FK_CONTENT_VERSION_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
        </addColumn>

        <sql>

            UPDATE contentversion cv
            INNER JOIN groupcontentversion gcv ON gcv.contentversion_id = cv.id
            SET
            cv.status = gcv.status,
            cv.devicegroup_id = gcv.devicegroup_id
        </sql>
        <dropTable tableName="groupcontentversion"/>
    </changeSet>
    <changeSet id="initial_devices" author="Ville Juutila">
        <createTable tableName="device">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="devicemodel_id" type="binary(16)">
                <constraints
                    nullable="true"
                    foreignKeyName="FK_DEVICE_DEVICE_MODEL_ID"
                    referencedColumnNames="id"
                    referencedTableName="devicemodel"/>
            </column>
            <column name="serialnumber" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(191)"/>
            <column name="description" type="varchar(191)"/>
            <column name="status" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="approvalstatus" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="devicekey" type="longblob"/>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)"/>
            <column name="lastseen" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addColumn tableName="exhibitiondevice">
            <column name="device_id" type="binary(16)">
                <constraints
                    nullable="true"
                    foreignKeyName="FK_EXHIBITION_DEVICE_DEVICE_ID"
                    referencedColumnNames="id"
                    referencedTableName="device"/>
            </column>
        </addColumn>
        <dropForeignKeyConstraint baseTableName="exhibitiondevice" constraintName="FK_EXHIBITION_DEVICE_DEVICE_MODEL_ID"/>
        <dropColumn tableName="exhibitiondevice">
            <column name="devicemodel_id"/>
        </dropColumn>
    </changeSet>

    <changeSet id="device_fleet_management_fields" author="Ville Juutila">
        <addColumn tableName="device">
            <column name="warrantyexpiry" type="datetime(6)"/>
            <column name="usagehours" type="double"/>
            <column name="lastconnected" type="datetime(6)"/>
        </addColumn>
    </changeSet>

    <changeSet id="activeexhibition" author="Antti Leppä">
        <addColumn tableName="exhibition">
            <column name="active" type="boolean">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>UPDATE exhibition SET active = false</sql>
        <sql>UPDATE exhibition JOIN (SELECT id FROM exhibition LIMIT 1) AS first_row ON exhibition.id = first_row.id SET active = TRUE</sql>
    </changeSet>

    <changeSet id="devicetype" author="Antti Leppä">
        <addColumn tableName="device">
            <column name="devicetype" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>UPDATE device SET devicetype = 'NOHEVA_ANDROID'</sql>
    </changeSet>

</databaseChangeLog>
